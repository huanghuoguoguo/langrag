<div x-show="nav.isActive('chat')" x-data="chatPage()" class="content-section" x-cloak>
    <div class="chat-layout">
        <!-- Left: Settings -->
        <div class="chat-sidebar">
            <div class="card">
                <h2>‚öôÔ∏è ÈÖçÁΩÆ</h2>

                <div class="form-group">
                    <label>LLM Ê®°Âûã</label>
                    <select class="form-select" x-model="selectedLLM">
                        <template x-for="llm in availableLLMs" :key="llm.name">
                            <option :value="llm.name" x-text="llm.name + ' (' + llm.model + ')'"
                                :selected="llm.name == activeLLM?.name"></option>
                        </template>
                    </select>
                </div>

                <div class="form-group" style="flex:1; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>ÈÄâÊã©Áü•ËØÜÂ∫ì</label>
                        <button class="btn-sm" @click="toggleAll()" x-text="isAllSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'"></button>
                    </div>
                    <div class="kb-selector">
                        <template x-if="isNoneSelected">
                            <div class="kb-selector-item" style="opacity:0.7; border-style:dashed;">
                                <div class="kb-selector-check">
                                    <span>ü§ñ</span>
                                </div>
                                <div>
                                    <div>Êô∫ËÉΩË∑ØÁî±Ê®°Âºè</div>
                                    <div class="text-muted text-sm">LLM Â∞ÜËá™Âä®ÈÄâÊã©ÂêàÈÄÇÁöÑÁü•ËØÜÂ∫ì</div>
                                </div>
                            </div>
                        </template>
                        <template x-for="kb in kbs" :key="kb.id">
                            <div class="kb-selector-item" @click="toggleKB(kb.id)"
                                :class="{ selected: isSelected(kb.id) }">
                                <div class="kb-selector-check">
                                    <span x-show="isSelected(kb.id)">‚úì</span>
                                </div>
                                <div>
                                    <div x-text="kb.name"></div>
                                    <div class="text-muted text-sm" x-text="kb.vdb_type"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="kbs.length === 0" class="text-muted">ÊöÇÊó†ÂèØÁî®Áü•ËØÜÂ∫ì</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Chat Area -->
        <div class="card chat-main">
            <div class="chat-header">
                <h2>üí¨ Â§öÁü•ËØÜÂ∫ìÈóÆÁ≠î</h2>
            </div>

            <div id="chat-messages" class="chat-messages">
                <template x-for="(msg, index) in messages" :key="index">
                    <div class="message" :class="msg.role">
                        <div class="avatar" x-text="msg.role === 'user' ? 'U' : 'AI'"></div>
                        <div class="message-content">
                            <div x-html="msg.content.replace(/\n/g, '<br>')"></div>

                            <!-- Sources -->
                            <template x-if="msg.sources && msg.sources.length > 0">
                                <div class="message-sources">
                                    <strong>ÂèÇËÄÉÊù•Ê∫ê:</strong>
                                    <template x-for="(s, si) in msg.sources" :key="si">
                                        <div class="source-item">
                                            <span class="source-icon"
                                                x-text="s.type === 'web_search' ? 'üåê' : 'üìÑ'"></span>
                                            <div>
                                                <div x-text="s.source || s.title || 'Êù•Ê∫ê ' + (si + 1)"></div>
                                                <div class="text-muted text-sm" x-text="'Score: ' + s.score.toFixed(2)">
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Evaluation -->
                            <template x-if="msg.role === 'assistant' && msg.sources?.length > 0">
                                <div class="eval-section">
                                    <button class="btn-sm" @click="evaluate(index)" x-show="!msg.evaluation"
                                        :disabled="msg.evaluating">
                                        <span x-show="!msg.evaluating">üìä ËØÑ‰º∞ÂõûÁ≠îË¥®Èáè</span>
                                        <span x-show="msg.evaluating">‚è≥ Ê≠£Âú®ËØÑ‰º∞...</span>
                                    </button>
                                    <template x-if="msg.evaluation">
                                        <div class="eval-results">
                                            <template x-for="(metric, key) in msg.evaluation" :key="key">
                                                <div class="eval-metric">
                                                    <div class="eval-metric-header">
                                                        <span
                                                            x-text="key === 'faithfulness' ? 'Âø†ÂÆûÂ∫¶' : (key === 'answer_relevancy' ? 'ÂõûÁ≠îÁõ∏ÂÖ≥ÊÄß' : '‰∏ä‰∏ãÊñáÁõ∏ÂÖ≥ÊÄß')"></span>
                                                        <span x-text="metric.score.toFixed(2)"></span>
                                                    </div>
                                                    <div class="eval-bar">
                                                        <div class="eval-bar-fill"
                                                            :style="'width:' + (metric.score * 100) + '%'">
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Loading indicator -->
                <div class="message assistant" x-show="loading">
                    <div class="avatar">AI</div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" x-model="input" placeholder="ËæìÂÖ•ÈóÆÈ¢ò..." @keyup.enter="send()">
                <button class="btn-primary" @click="send()" :disabled="loading">
                    <span x-show="!loading">ÂèëÈÄÅ</span>
                    <span x-show="loading" class="loader"></span>
                </button>
            </div>
        </div>
    </div>
</div>