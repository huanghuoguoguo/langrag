<div x-show="nav.isActive('chat')" x-data="chatPage()" class="content-section" x-cloak>
    <div class="chat-layout">
        <!-- Left: Settings -->
        <div class="chat-sidebar">
            <div class="card">
                <h2>‚öôÔ∏è ÈÖçÁΩÆ</h2>

                <div class="form-group">
                    <label>ÂØπËØùÊ®°Âûã</label>
                    <select class="form-select" x-model="selectedLLM">
                        <template x-for="llm in availableLLMs" :key="llm.name">
                            <option :value="llm.name" x-text="llm.name + ' (' + llm.model + ')'"></option>
                        </template>
                    </select>
                </div>

                <!-- Agent Ê®°Âºè -->
                <div class="form-group">
                    <label class="checkbox-label" style="font-weight: 600;">
                        <input type="checkbox" x-model="useAgent">
                        <span>ü§ñ Agent Ê®°Âºè (Agentic RAG)</span>
                    </label>
                    <div x-show="useAgent" class="config-hint" style="margin-top: 4px; padding: 8px; background: var(--bg-primary); border-radius: 6px; font-size: 0.85em;">
                        <div style="color: var(--text-secondary); margin-bottom: 4px;">LLM Ëá™‰∏ªÂÜ≥ÂÆöÊòØÂê¶ÈúÄË¶ÅÊ£ÄÁ¥¢</div>
                        <div class="config-row" style="margin-top: 8px;">
                            <label class="config-label-small">ÊúÄÂ§ßÊ≠•Êï∞:</label>
                            <select x-model="agentMaxSteps" class="form-select-mini">
                                <option value="3">3</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Ê£ÄÁ¥¢ÈÖçÁΩÆ -->
                <div class="form-group">
                    <label>Ê£ÄÁ¥¢ÈÖçÁΩÆ</label>
                    <div class="retrieval-config">
                        <!-- RerankÈÖçÁΩÆ -->
                        <div class="config-row">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="useRerank">
                                <span>ÈáçÊéíÂ∫è (Rerank)</span>
                            </label>
                            <select x-model="selectedReranker" :disabled="!useRerank" class="form-select-mini">
                                <option value="">ÈÄâÊã©Á±ªÂûã...</option>
                                <option value="llm_template">LLMÊ®°Êùø</option>
                                <option value="cohere">Cohere</option>
                                <option value="qwen">Qwen</option>
                                <option value="noop">NoOp</option>
                            </select>
                        </div>

                        <!-- Reranker LLMÈÄâÊã© (‰ªÖÂú®ÈÄâÊã©llm_templateÊó∂ÊòæÁ§∫) -->
                        <div class="config-row" x-show="useRerank && selectedReranker === 'llm_template'">
                            <label class="config-label-small">ÈáçÊéíÂ∫èÊ®°Âûã:</label>
                            <select x-model="selectedRerankerLLM" class="form-select-mini">
                                <template x-for="llm in availableLLMs" :key="llm.name">
                                    <option :value="llm.name" x-text="llm.name"></option>
                                </template>
                            </select>
                        </div>

                        <!-- RouterÈÖçÁΩÆ -->
                        <div class="config-row">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="useRouter">
                                <span>Êô∫ËÉΩË∑ØÁî± (Router)</span>
                            </label>
                            <select x-model="selectedRouter" :disabled="!useRouter" class="form-select-mini">
                                <template x-for="llm in availableLLMs" :key="llm.name">
                                    <option :value="llm.name" x-text="llm.name"></option>
                                </template>
                            </select>
                        </div>

                        <!-- RewriterÈÖçÁΩÆ -->
                        <div class="config-row">
                            <label class="checkbox-label">
                                <input type="checkbox" x-model="useRewriter">
                                <span>Êü•ËØ¢ÈáçÂÜô (Rewriter)</span>
                            </label>
                            <select x-model="selectedRewriter" :disabled="!useRewriter" class="form-select-mini">
                                <template x-for="llm in availableLLMs" :key="llm.name">
                                    <option :value="llm.name" x-text="llm.name"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="flex:1; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>ÈÄâÊã©Áü•ËØÜÂ∫ì</label>
                        <button class="btn-sm" @click="toggleAll()" x-text="isAllSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'"></button>
                    </div>
                    <div class="kb-selector">
                        <template x-if="isNoneSelected">
                            <div class="kb-selector-item" style="opacity:0.7; border-style:dashed;">
                                <div class="kb-selector-check">
                                    <span>ü§ñ</span>
                                </div>
                                <div>
                                    <div>Êô∫ËÉΩË∑ØÁî±Ê®°Âºè</div>
                                    <div class="text-muted text-sm">LLM Â∞ÜËá™Âä®ÈÄâÊã©ÂêàÈÄÇÁöÑÁü•ËØÜÂ∫ì</div>
                                </div>
                            </div>
                        </template>
                        <template x-for="kb in kbs" :key="kb.id">
                            <div class="kb-selector-item" @click="toggleKB(kb.id)"
                                :class="{ selected: isSelected(kb.id) }">
                                <div class="kb-selector-check">
                                    <span x-show="isSelected(kb.id)">‚úì</span>
                                </div>
                                <div>
                                    <div x-text="kb.name"></div>
                                    <div class="text-muted text-sm" x-text="kb.vdb_type"></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="kbs.length === 0" class="text-muted">ÊöÇÊó†ÂèØÁî®Áü•ËØÜÂ∫ì</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Chat Area -->
        <div class="card chat-main">
            <div class="chat-header">
                <h2>üí¨ Â§öÁü•ËØÜÂ∫ìÈóÆÁ≠î</h2>
            </div>

            <div id="chat-messages" class="chat-messages">
                <template x-for="(msg, index) in messages" :key="index">
                    <div class="message" :class="msg.role">
                        <div class="avatar" x-text="msg.role === 'user' ? 'U' : 'AI'"></div>
                        <div class="message-content">
                            <div x-html="msg.content.replace(/\n/g, '<br>')"></div>

                            <!-- Message Footer: Actions & Details -->
                            <!-- Message Footer: Actions & Details -->
                            <div class="message-footer" x-data="{ activeDetail: null }">

                                <!-- 0. Agent Trace Button -->
                                <template x-if="msg.agent_trace && msg.agent_trace.length > 0">
                                    <button class="btn-sm btn-outline btn-status"
                                        :class="{ 'active': activeDetail === 'agent' }"
                                        @click="activeDetail = activeDetail === 'agent' ? null : 'agent'"
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                        <span>ü§ñ</span>
                                        <span x-text="msg.pipeline?.agent?.total_tool_calls + ' Ê¨°Â∑•ÂÖ∑Ë∞ÉÁî®'"></span>
                                        <span class="text-xs" x-show="activeDetail !== 'agent'">‚ñº</span>
                                        <span class="text-xs" x-show="activeDetail === 'agent'">‚ñ≤</span>
                                    </button>
                                </template>

                                <!-- 1. Retrieval Toggle Button (Sources) -->
                                <template x-if="msg.retrieval_stats">
                                    <button class="btn-sm btn-outline btn-status"
                                        :class="{ 'active': activeDetail === 'sources' }"
                                        @click="activeDetail = activeDetail === 'sources' ? null : 'sources'">
                                        <span>üìÑ</span>
                                        <span x-text="(msg.sources ? msg.sources.length : 0) + ' Êù•Ê∫ê'"></span>
                                        <span class="text-xs" x-show="activeDetail !== 'sources'">‚ñº</span>
                                        <span class="text-xs" x-show="activeDetail === 'sources'">‚ñ≤</span>
                                    </button>
                                </template>

                                <!-- 2. Rewriter Button -->
                                <template x-if="msg.retrieval_stats?.pipeline?.rewriter?.enabled">
                                    <button class="btn-sm btn-outline btn-status"
                                        :class="{ 'active': activeDetail === 'rewriter' }"
                                        @click="activeDetail = activeDetail === 'rewriter' ? null : 'rewriter'">
                                        <span>‚úçÔ∏è</span>
                                        <span>Â∑≤ÈáçÂÜô</span>
                                        <span class="text-xs" x-show="activeDetail !== 'rewriter'">‚ñº</span>
                                        <span class="text-xs" x-show="activeDetail === 'rewriter'">‚ñ≤</span>
                                    </button>
                                </template>

                                <!-- 3. Router Button -->
                                <template x-if="msg.retrieval_stats?.pipeline?.router?.enabled">
                                    <button class="btn-sm btn-outline btn-status"
                                        :class="{ 'active': activeDetail === 'router' }"
                                        @click="activeDetail = activeDetail === 'router' ? null : 'router'">
                                        <span>ü§ñ</span>
                                        <span>Â∑≤Ë∑ØÁî±</span>
                                        <span class="text-xs" x-show="activeDetail !== 'router'">‚ñº</span>
                                        <span class="text-xs" x-show="activeDetail === 'router'">‚ñ≤</span>
                                    </button>
                                </template>

                                <!-- 4. Reranker Button -->
                                <template x-if="msg.retrieval_stats?.pipeline?.reranker?.enabled">
                                    <button class="btn-sm btn-outline btn-status"
                                        :class="{ 'active': activeDetail === 'reranker' }"
                                        @click="activeDetail = activeDetail === 'reranker' ? null : 'reranker'">
                                        <span>üìö</span>
                                        <span>Â∑≤ÈáçÊéí</span>
                                        <span class="text-xs" x-show="activeDetail !== 'reranker'">‚ñº</span>
                                        <span class="text-xs" x-show="activeDetail === 'reranker'">‚ñ≤</span>
                                    </button>
                                </template>

                                <!-- 5. Evaluation Button -->
                                <template x-if="msg.role === 'assistant' && msg.sources?.length > 0">
                                    <button class="btn-sm btn-outline btn-status" @click="evaluate(index)"
                                        :disabled="msg.evaluating" style="margin-left:auto;">
                                        <span x-show="!msg.evaluating">üìä ËØÑ‰º∞Ë¥®Èáè</span>
                                        <span x-show="msg.evaluating">‚è≥ ËØÑ‰º∞‰∏≠...</span>
                                    </button>
                                </template>

                                <!-- 6. UNIFIED DETAIL PANEL -->
                                <template x-if="activeDetail">
                                    <div class="detail-panel" x-show="activeDetail" x-transition.opacity.duration.200ms>

                                        <!-- CONTENT: Agent Trace -->
                                        <div x-show="activeDetail === 'agent'">
                                            <div class="detail-panel-header">
                                                <span>ü§ñ Agent ÊâßË°åËΩ®Ëøπ</span>
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <span class="text-xs text-muted" x-text="msg.pipeline?.agent?.elapsed_ms + 'ms'"></span>
                                                    <button class="btn-icon text-muted" @click="activeDetail = null">‚úï</button>
                                                </div>
                                            </div>
                                            <div style="display:flex; flex-direction:column; gap:12px;">
                                                <template x-for="(step, stepIdx) in msg.agent_trace" :key="stepIdx">
                                                    <div style="background:var(--bg-primary); border-radius:8px; padding:12px; border-left:3px solid var(--primary-color);">
                                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                                            <span style="font-weight:600;">Step <span x-text="step.step"></span></span>
                                                            <span class="text-xs text-muted" x-text="step.elapsed_ms + 'ms'"></span>
                                                        </div>
                                                        <!-- Thought -->
                                                        <template x-if="step.thought">
                                                            <div style="margin-bottom:8px; padding:8px; background:var(--bg-secondary); border-radius:6px; font-size:0.9em;">
                                                                <div class="text-xs text-muted" style="margin-bottom:4px;">üí≠ ÊÄùËÄÉ</div>
                                                                <div x-text="step.thought.substring(0, 200) + (step.thought.length > 200 ? '...' : '')"></div>
                                                            </div>
                                                        </template>
                                                        <!-- Tool Calls -->
                                                        <template x-for="(tc, tcIdx) in step.tool_calls" :key="tcIdx">
                                                            <div style="margin-top:8px; padding:8px; background:linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%); border-radius:6px;">
                                                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                                                    <span style="font-weight:500; color:var(--primary-color);">
                                                                        üîß <span x-text="tc.name"></span>
                                                                    </span>
                                                                    <span class="text-xs text-muted" x-text="tc.elapsed_ms + 'ms'"></span>
                                                                </div>
                                                                <div class="text-xs" style="margin-top:4px; font-family:monospace; color:var(--text-secondary);">
                                                                    ÂèÇÊï∞: <span x-text="JSON.stringify(tc.arguments)"></span>
                                                                </div>
                                                                <template x-if="tc.error">
                                                                    <div style="margin-top:4px; color:var(--error-color); font-size:0.85em;">
                                                                        ‚ùå <span x-text="tc.error"></span>
                                                                    </div>
                                                                </template>
                                                                <template x-if="!tc.error && tc.result">
                                                                    <div x-data="{ showResult: false }" style="margin-top:4px;">
                                                                        <button class="btn-sm btn-outline" @click="showResult = !showResult" style="font-size:0.75em; padding:2px 8px;">
                                                                            <span x-text="showResult ? 'ÈöêËóèÁªìÊûú' : 'Êü•ÁúãÁªìÊûú'"></span>
                                                                        </button>
                                                                        <div x-show="showResult" x-transition style="margin-top:8px; padding:8px; background:var(--bg-secondary); border-radius:4px; font-size:0.85em; max-height:200px; overflow-y:auto; white-space:pre-wrap;">
                                                                            <span x-text="tc.result"></span>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                            <!-- Summary -->
                                            <div style="margin-top:12px; padding:8px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:6px; color:white; font-size:0.85em; display:flex; justify-content:space-around;">
                                                <span>‚úÖ <span x-text="msg.pipeline?.agent?.finished_reason"></span></span>
                                                <span>üìä <span x-text="msg.pipeline?.agent?.total_steps"></span> Ê≠•</span>
                                                <span>üîß <span x-text="msg.pipeline?.agent?.total_tool_calls"></span> Ê¨°Ë∞ÉÁî®</span>
                                            </div>
                                        </div>

                                        <!-- CONTENT: Sources -->
                                        <div x-show="activeDetail === 'sources'">
                                            <div class="detail-panel-header">
                                                <span>ÂèÇËÄÉÊù•Ê∫êËØ¶ÊÉÖ</span>
                                                <button class="btn-icon text-muted"
                                                    @click="activeDetail = null">‚úï</button>
                                            </div>
                                            <div class="drawer-sources-grid">
                                                <template x-for="(s, si) in msg.sources" :key="si">
                                                    <div class="drawer-source-card" x-data="{ showPreview: false }"
                                                        @mouseenter="showPreview=true" @mouseleave="showPreview=false">
                                                        <div class="source-card-top" style="margin-bottom:4px;">
                                                            <div class="source-index" x-text="si + 1"></div>
                                                            <div class="source-title"
                                                                x-text="s.source || s.title || 'Source ' + (si+1)">
                                                            </div>
                                                        </div>
                                                        <div class="source-snippet"
                                                            x-text="s.content ? s.content.substring(0, 50) + '...' : ''">
                                                        </div>
                                                        <div class="source-score-bar"
                                                            :style="'width: ' + (s.score * 100) + '%'"></div>
                                                        <!-- Hover Preview for Source Card still makes sense as it is sub-detail -->
                                                        <div class="source-full-preview" x-show="showPreview"
                                                            x-transition
                                                            style="bottom: 105%; left:0; width: 280px; max-height: 400px;">
                                                            <div x-text="s.content"></div>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div x-show="!msg.sources || msg.sources.length === 0"
                                                    class="text-muted text-sm">
                                                    Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÊñáÊ°£
                                                </div>
                                            </div>
                                        </div>

                                        <!-- CONTENT: Rewriter -->
                                        <div x-show="activeDetail === 'rewriter'">
                                            <div class="detail-panel-header">
                                                <span>Êü•ËØ¢ÈáçÂÜôËØ¶ÊÉÖ</span>
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <span class="text-xs text-muted"
                                                        x-text="msg.retrieval_stats?.pipeline?.rewriter?.model"></span>
                                                    <button class="btn-icon text-muted"
                                                        @click="activeDetail = null">‚úï</button>
                                                </div>
                                            </div>
                                            <div class="detail-content-row"
                                                style="flex-direction:column; align-items:flex-start; gap:12px;">
                                                <div>
                                                    <div class="text-xs text-muted uppercase">Original Query</div>
                                                    <div style="opacity:0.7; text-decoration:line-through; font-size: 1em;"
                                                        x-text="msg.retrieval_stats?.pipeline?.rewriter?.original">
                                                    </div>
                                                </div>
                                                <div style="align-self:center; color: var(--success-color);">‚¨á Rewrite ‚¨á
                                                </div>
                                                <div>
                                                    <div class="text-xs text-muted uppercase">Rewritten Query</div>
                                                    <div style="font-weight:600; font-size: 1.1em; color: var(--text-primary);"
                                                        x-text="msg.retrieval_stats?.pipeline?.rewriter?.output"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- CONTENT: Router -->
                                        <div x-show="activeDetail === 'router'">
                                            <div class="detail-panel-header">
                                                <span>Áü•ËØÜÂ∫ìË∑ØÁî±ÁªìÊûú</span>
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <span class="text-xs text-muted"
                                                        x-text="msg.retrieval_stats?.pipeline?.router?.model"></span>
                                                    <button class="btn-icon text-muted"
                                                        @click="activeDetail = null">‚úï</button>
                                                </div>
                                            </div>
                                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                                <template
                                                    x-for="kb in msg.retrieval_stats?.pipeline?.router?.selected_kbs">
                                                    <span
                                                        style="background:var(--bg-primary); border:1px solid var(--border-color); padding:6px 12px; border-radius:16px; font-size:0.9em; display:flex; align-items:center; gap:6px;">
                                                        <span>üìÅ</span>
                                                        <span x-text="kb.name"></span>
                                                    </span>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- CONTENT: Reranker -->
                                        <div x-show="activeDetail === 'reranker'">
                                            <div class="detail-panel-header">
                                                <span>ÈáçÊéí‰ºòÂåñ (Re-ranking)</span>
                                                <div style="display:flex; align-items:center; gap:8px;">
                                                    <span class="text-xs text-muted"
                                                        x-text="msg.retrieval_stats?.pipeline?.reranker?.model"></span>
                                                    <button class="btn-icon text-muted"
                                                        @click="activeDetail = null">‚úï</button>
                                                </div>
                                            </div>
                                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
                                                <div
                                                    style="background:var(--bg-primary); padding:12px; border-radius:8px; text-align:center;">
                                                    <div class="text-xs text-muted uppercase">Input Documents</div>
                                                    <div style="font-size:1.5em; font-weight:600;"
                                                        x-text="msg.retrieval_stats?.pipeline?.reranker?.input_count">
                                                    </div>
                                                </div>
                                                <div
                                                    style="background:var(--bg-primary); padding:12px; border-radius:8px; text-align:center;">
                                                    <div class="text-xs text-muted uppercase">Output Documents</div>
                                                    <div style="font-size:1.5em; font-weight:600; color:var(--primary-color);"
                                                        x-text="msg.retrieval_stats?.pipeline?.reranker?.output_count">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </template>

                                <!-- 7. Evaluation Results -->
                                <template x-if="msg.evaluation">
                                    <div class="eval-results" style="width: 100%; margin-top: 8px;">
                                        <template x-for="(metric, key) in msg.evaluation" :key="key">
                                            <div class="eval-metric">
                                                <div class="eval-metric-header">
                                                    <span
                                                        x-text="key === 'faithfulness' ? 'Âø†ÂÆûÂ∫¶' : (key === 'answer_relevancy' ? 'ÂõûÁ≠îÁõ∏ÂÖ≥ÊÄß' : '‰∏ä‰∏ãÊñáÁõ∏ÂÖ≥ÊÄß')"></span>
                                                    <span x-text="metric.score.toFixed(2)"></span>
                                                </div>
                                                <div class="eval-bar">
                                                    <div class="eval-bar-fill"
                                                        :style="'width:' + (metric.score * 100) + '%'"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                            </div>
                        </div>
                    </div>
                </template>

                <!-- Loading indicator -->
                <div class="message assistant" x-show="loading">
                    <div class="avatar">AI</div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" x-model="input" placeholder="ËæìÂÖ•ÈóÆÈ¢ò..." @keyup.enter="send()">
                <button class="btn-primary" @click="send()" :disabled="loading">
                    <span x-show="!loading">ÂèëÈÄÅ</span>
                    <span x-show="loading" class="loader"></span>
                </button>
            </div>
        </div>
    </div>
</div>