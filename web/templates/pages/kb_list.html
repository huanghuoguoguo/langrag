<div x-show="nav.isActive('kb-list')" x-data="kbListPage()" class="content-section" x-cloak>
    <div class="section-header">
        <div>
            <h1>知识库列表</h1>
            <p class="subtitle">管理您的所有知识库</p>
        </div>
        <button class="btn-primary" @click="openModal()">+ 创建知识库</button>
    </div>

    <div class="container">
        <!-- Loading State -->
        <div x-show="loading" class="loading-state">
            <div class="loader"></div>
            <p>加载中...</p>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && kbs.length === 0" class="empty-state">
            <p>📚 还没有知识库</p>
            <p style="font-size:0.9rem; margin-top:0.5rem; color:var(--text-muted);">点击"创建知识库"开始</p>
        </div>

        <!-- KB Cards -->
        <div class="kb-grid" x-show="!loading && kbs.length > 0">
            <template x-for="kb in kbs" :key="kb.id">
                <div class="card kb-card" @click="selectKB(kb)">
                    <div class="kb-card-header">
                        <div class="kb-card-title" x-text="kb.name"></div>
                        <p class="kb-card-desc" x-text="kb.description || '无描述'"></p>
                    </div>
                    <div class="kb-card-meta">
                        <span class="badge primary" x-text="kb.vdb_type"></span>
                        <span class="badge success" x-show="kb.embedder_name" x-text="kb.embedder_name"></span>
                        <span class="badge" x-show="!kb.embedder_name">无 Embedder</span>
                        <span class="badge" x-text="'Chunk: ' + kb.chunk_size"></span>
                        <span class="badge info" x-text="getIndexingName(kb.indexing_technique)"></span>
                        <span class="badge warning" x-show="kb.indexing_llm_name" x-text="'LLM: ' + kb.indexing_llm_name"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Create KB Modal -->
    <div class="modal" :class="{ active: showModal }" @click.self="showModal = false">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>创建知识库</h2>
                <span class="modal-close" @click="showModal = false">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 基本信息 -->
                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">📚 基本信息</h3>
                <div class="form-group">
                    <label>名称 *</label>
                    <input type="text" x-model="form.name" placeholder="例如：2024财务文档">
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <textarea x-model="form.description" rows="2" placeholder="关于该数据集的描述..."></textarea>
                </div>

                <!-- 离线/索引配置 -->
                <h3 style="margin: 1.5rem 0 1rem; color: var(--text-primary);">⚙️ 索引配置</h3>
                <p class="form-hint" style="margin-bottom: 1rem;">
                    ⚠️ 以下配置创建后不可修改，请谨慎选择
                </p>
                <div class="form-group">
                    <label>向量数据库 *</label>
                    <select x-model="form.vdb_type">
                        <option value="chroma">ChromaDB</option>
                        <option value="duckdb">DuckDB</option>
                        <option value="seekdb">SeekDB（支持混合检索）</option>
                        <option value="web_search">🌐 互联网搜索（实时联网）</option>
                    </select>
                    <p class="form-hint">
                        💡 <strong>SeekDB</strong> 支持混合检索（向量+全文）
                    </p>
                </div>
                <div class="form-group" x-show="!isWebSearch">
                    <label>Embedding 模型 *</label>
                    <select x-model="form.embedder_name">
                        <option value="">请选择 Embedder...</option>
                        <template x-for="emb in embedders" :key="emb.name">
                            <option :value="emb.name" x-text="emb.name + ' (' + emb.embedder_type + ')'">
                            </option>
                        </template>
                    </select>
                    <p class="form-hint">决定向量维度，创建后不可更改</p>
                </div>

                <!-- 索引策略 -->
                <div class="form-group" x-show="!isWebSearch">
                    <label>索引策略 *</label>
                    <select x-model="form.indexing_technique">
                        <option value="paragraph">📄 段落索引（默认）- 直接切分文档</option>
                        <option value="qa">❓ QA 索引 - 生成问答对，需要 LLM</option>
                        <option value="raptor">🌳 RAPTOR 索引 - 层级摘要，需要 LLM</option>
                    </select>
                    <p class="form-hint">
                        💡 <strong>QA 索引</strong>：用 LLM 生成问答对，提高问答准确性<br>
                        💡 <strong>RAPTOR 索引</strong>：构建层级摘要树，适合长文档理解
                    </p>
                </div>

                <!-- LLM 选择（QA/RAPTOR 需要） -->
                <div class="form-group" x-show="!isWebSearch && needsLLM" x-transition>
                    <label>索引用 LLM *</label>
                    <select x-model="form.indexing_llm_name">
                        <option value="">请选择 LLM...</option>
                        <template x-for="llm in llms" :key="llm.name">
                            <option :value="llm.name" x-text="llm.name + ' (' + llm.model + ')'">
                            </option>
                        </template>
                    </select>
                    <p class="form-hint">
                        ⚠️ 用于离线生成问答对/摘要，会产生 LLM 调用费用
                    </p>
                </div>

                <div class="form-row" x-show="!isWebSearch">
                    <div class="form-group">
                        <label>分块大小</label>
                        <input type="number" x-model.number="form.chunk_size" min="100" max="4000" step="100">
                    </div>
                    <div class="form-group">
                        <label>分块重叠</label>
                        <input type="number" x-model.number="form.chunk_overlap" min="0" max="500" step="50">
                    </div>
                </div>

                <p class="form-hint" style="margin-top: 1rem; padding: 0.75rem; background: var(--surface-secondary); border-radius: 4px;">
                    💡 <strong>检索配置</strong>（Reranker、Rewriter、Router）在聊天时动态选择，无需在此配置
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @click="showModal = false">取消</button>
                <button class="btn-primary" @click="createKB()" :disabled="creating">
                    <span x-show="!creating">创建</span>
                    <span x-show="creating" class="loader"></span>
                </button>
            </div>
        </div>
    </div>
</div>
