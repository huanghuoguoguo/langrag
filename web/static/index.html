<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangRAG ÊéßÂà∂Âè∞</title>
    <link rel="stylesheet" href="style.css">
    <!-- JS Modules (load before Alpine.js) -->
    <script src="js/core/api.js"></script>
    <script src="js/core/utils.js"></script>
    <script src="js/core/stores.js"></script>
    <script src="js/pages/kb-list.js"></script>
    <script src="js/pages/kb-detail.js"></script>
    <script src="js/pages/chat.js"></script>
    <script src="js/pages/models.js"></script>
    <script src="js/pages/playground.js"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="{ nav: $store.nav }">

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
            LangRAG
        </div>

        <div class="nav-item" :class="{ active: nav.isActive('kb-list') }" @click="nav.goto('kb-list')">
            <span>üìö Áü•ËØÜÂ∫ìÂàóË°®</span>
        </div>
        <div class="nav-item" :class="{ active: nav.isActive('kb-detail') }" x-show="nav.currentKB"
            @click="nav.goto('kb-detail')">
            <span>üìÑ Áü•ËØÜÂ∫ìËØ¶ÊÉÖ</span>
        </div>
        <div class="nav-item" :class="{ active: nav.isActive('chat') }" @click="nav.goto('chat')">
            <span>üí¨ AI ÂØπËØù</span>
        </div>
        <div class="nav-item" :class="{ active: nav.isActive('playground') }" @click="nav.goto('playground')">
            <span>üß™ Playground</span>
        </div>
        <div class="nav-item" :class="{ active: nav.isActive('models') }" @click="nav.goto('models')">
            <span>‚öôÔ∏è Ê®°ÂûãÈÖçÁΩÆ</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- ================================================================== -->
        <!-- KB List Section -->
        <!-- ================================================================== -->
        <div x-show="nav.isActive('kb-list')" x-data="kbListPage()" class="content-section" x-cloak>
            <div class="section-header">
                <div>
                    <h1>Áü•ËØÜÂ∫ìÂàóË°®</h1>
                    <p class="subtitle">ÁÆ°ÁêÜÊÇ®ÁöÑÊâÄÊúâÁü•ËØÜÂ∫ì</p>
                </div>
                <button class="btn-primary" @click="openModal()">+ ÂàõÂª∫Áü•ËØÜÂ∫ì</button>
            </div>

            <div class="container">
                <!-- Loading State -->
                <div x-show="loading" class="loading-state">
                    <div class="loader"></div>
                    <p>Âä†ËΩΩ‰∏≠...</p>
                </div>

                <!-- Empty State -->
                <div x-show="!loading && kbs.length === 0" class="empty-state">
                    <p>üìö ËøòÊ≤°ÊúâÁü•ËØÜÂ∫ì</p>
                    <p style="font-size:0.9rem; margin-top:0.5rem; color:var(--text-muted);">ÁÇπÂáª"ÂàõÂª∫Áü•ËØÜÂ∫ì"ÂºÄÂßã</p>
                </div>

                <!-- KB Cards -->
                <div class="kb-grid" x-show="!loading && kbs.length > 0">
                    <template x-for="kb in kbs" :key="kb.id">
                        <div class="card kb-card" @click="selectKB(kb)">
                            <div class="kb-card-header">
                                <div class="kb-card-title" x-text="kb.name"></div>
                                <p class="kb-card-desc" x-text="kb.description || 'Êó†ÊèèËø∞'"></p>
                            </div>
                            <div class="kb-card-meta">
                                <span class="badge primary" x-text="kb.vdb_type"></span>
                                <span class="badge success" x-show="kb.embedder_name" x-text="kb.embedder_name"></span>
                                <span class="badge" x-show="!kb.embedder_name">Êó† Embedder</span>
                                <span class="badge" x-text="'Chunk: ' + kb.chunk_size"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Create KB Modal -->
            <div class="modal" :class="{ active: showModal }" @click.self="showModal = false">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>ÂàõÂª∫Áü•ËØÜÂ∫ì</h2>
                        <span class="modal-close" @click="showModal = false">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>ÂêçÁß∞ *</label>
                            <input type="text" x-model="form.name" placeholder="‰æãÂ¶ÇÔºö2024Ë¥¢Âä°ÊñáÊ°£">
                        </div>
                        <div class="form-group">
                            <label>ÊèèËø∞</label>
                            <textarea x-model="form.description" rows="2" placeholder="ÂÖ≥‰∫éËØ•Êï∞ÊçÆÈõÜÁöÑÊèèËø∞..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>ÂêëÈáèÊï∞ÊçÆÂ∫ì *</label>
                            <select x-model="form.vdb_type">
                                <option value="chroma">ChromaDB</option>
                                <option value="duckdb">DuckDB</option>
                                <option value="seekdb">SeekDBÔºàÊîØÊåÅÊ∑∑ÂêàÊ£ÄÁ¥¢Ôºâ</option>
                                <option value="web_search">üåê ‰∫íËÅîÁΩëÊêúÁ¥¢ÔºàÂÆûÊó∂ËÅîÁΩëÔºâ</option>
                            </select>
                            <p class="form-hint">
                                üí° <strong>SeekDB</strong> ÊîØÊåÅÊ∑∑ÂêàÊ£ÄÁ¥¢ÔºàÂêëÈáè+ÂÖ®ÊñáÔºâ<br>
                                üåê <strong>‰∫íËÅîÁΩëÊêúÁ¥¢</strong> ‰ΩøÁî® DuckDuckGo ÂÆûÊó∂ÊêúÁ¥¢
                            </p>
                        </div>
                        <div class="form-group" x-show="!isWebSearch">
                            <label>Embedding Ê®°Âûã *</label>
                            <select x-model="form.embedder_name">
                                <option value="">ËØ∑ÈÄâÊã© Embedder...</option>
                                <template x-for="emb in embedders" :key="emb.name">
                                    <option :value="emb.name" x-text="emb.name + ' (' + emb.embedder_type + ')'">
                                    </option>
                                </template>
                            </select>
                        </div>
                        <div class="form-row" x-show="!isWebSearch">
                            <div class="form-group">
                                <label>ÂàÜÂùóÂ§ßÂ∞è</label>
                                <input type="number" x-model.number="form.chunk_size" min="100" max="4000" step="100">
                            </div>
                            <div class="form-group">
                                <label>ÂàÜÂùóÈáçÂè†</label>
                                <input type="number" x-model.number="form.chunk_overlap" min="0" max="500" step="50">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" @click="showModal = false">ÂèñÊ∂à</button>
                        <button class="btn-primary" @click="createKB()" :disabled="creating">
                            <span x-show="!creating">ÂàõÂª∫</span>
                            <span x-show="creating" class="loader"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================== -->
        <!-- KB Detail Section -->
        <!-- ================================================================== -->
        <div x-show="nav.isActive('kb-detail')" x-data="kbDetailPage()" class="content-section" x-cloak>
            <template x-if="kb">
                <div>
                    <div class="section-header">
                        <div>
                            <h1 x-text="kb.name"></h1>
                            <p class="subtitle" x-text="kb.description || 'Êó†ÊèèËø∞'"></p>
                        </div>
                        <div class="btn-group">
                            <button class="btn-secondary" @click="goBack()">‚Üê ËøîÂõûÂàóË°®</button>
                            <button class="btn-danger" @click="deleteKB()">Âà†Èô§</button>
                        </div>
                    </div>

                    <div class="container">
                        <!-- KB Info Card -->
                        <div class="card">
                            <h2>üìã Áü•ËØÜÂ∫ì‰ø°ÊÅØ</h2>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>ID</label>
                                    <div class="info-value mono" x-text="kb.id"></div>
                                </div>
                                <div class="info-item">
                                    <label>ÂêëÈáèÊï∞ÊçÆÂ∫ì</label>
                                    <div class="info-value" x-text="kb.vdb_type"></div>
                                </div>
                                <div class="info-item">
                                    <label>Embedding Ê®°Âûã</label>
                                    <div class="info-value" x-text="kb.embedder_name || 'Êú™ÈÖçÁΩÆ'"></div>
                                </div>
                                <div class="info-item">
                                    <label>ÂàÜÂùóÈÖçÁΩÆ</label>
                                    <div class="info-value" x-text="kb.chunk_size + ' / ' + kb.chunk_overlap"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Card -->
                        <div class="card">
                            <h2>üì§ ‰∏ä‰º†ÊñáÊ°£</h2>
                            <div class="dropzone" @dragover.prevent="$el.classList.add('dragover')"
                                @dragleave.prevent="$el.classList.remove('dragover')"
                                @drop.prevent="$el.classList.remove('dragover'); handleFiles($event)"
                                @click="$refs.fileInput.click()">
                                <p>Â∞ÜÊñá‰ª∂ÊãñÊãΩËá≥Ê≠§ÔºåÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</p>
                                <input type="file" x-ref="fileInput" multiple @change="handleFiles($event)"
                                    style="display:none">
                            </div>

                            <!-- Files to upload -->
                            <div class="file-list" x-show="filesToUpload.length > 0">
                                <template x-for="(file, index) in filesToUpload" :key="index">
                                    <div class="file-item">
                                        <span x-text="file.name"></span>
                                        <div class="file-item-actions">
                                            <span class="badge" x-text="(file.size / 1024).toFixed(1) + ' KB'"></span>
                                            <button class="btn-icon" @click="removeFile(index)">√ó</button>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <div class="card-actions">
                                <button class="btn-primary" @click="upload()"
                                    :disabled="uploading || filesToUpload.length === 0">
                                    <span x-show="!uploading">ÂºÄÂßãÂ§ÑÁêÜ</span>
                                    <span x-show="uploading" class="loader"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Documents List -->
                        <div class="card">
                            <h2>üìÅ Â∑≤‰∏ä‰º†ÊñáÊ°£</h2>
                            <div x-show="documents.length === 0" class="empty-hint">ËøòÊ≤°Êúâ‰∏ä‰º†ÊñáÊ°£</div>
                            <div class="file-list" x-show="documents.length > 0">
                                <template x-for="doc in documents" :key="doc.id">
                                    <div class="file-item">
                                        <div>
                                            <div x-text="doc.filename"></div>
                                            <div class="file-meta">
                                                <span x-text="(doc.file_size / 1024).toFixed(1) + ' KB'"></span>
                                                <span>¬∑</span>
                                                <span x-text="doc.chunk_count + ' chunks'"></span>
                                            </div>
                                        </div>
                                        <span class="badge" :class="{ success: doc.status === 'completed' }"
                                            x-text="doc.status"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Search Card -->
                        <div class="card">
                            <h2>üîç Ê£ÄÁ¥¢ÊµãËØï</h2>

                            <!-- Search Options -->
                            <div class="search-options">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ê£ÄÁ¥¢Ê®°Âºè</label>
                                        <select x-model="searchMode">
                                            <option value="auto">Ëá™Âä®ÈÄâÊã©</option>
                                            <option value="hybrid">Ê∑∑ÂêàÊ£ÄÁ¥¢ (ÂêëÈáè+ÂÖ≥ÈîÆËØç)</option>
                                            <option value="vector">ÂêëÈáèÊ£ÄÁ¥¢</option>
                                            <option value="keyword">ÂÖ≥ÈîÆËØçÊ£ÄÁ¥¢</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Rerank ÈáçÊéíÂ∫è</label>
                                        <select x-model="useRerank">
                                            <option :value="null">ÈªòËÆ§ (Ëá™Âä®)</option>
                                            <option :value="true">ÂêØÁî®</option>
                                            <option :value="false">Á¶ÅÁî®</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Query ÈáçÂÜô</label>
                                        <select x-model="useRewrite">
                                            <option :value="false">Á¶ÅÁî®</option>
                                            <option :value="true">ÂêØÁî® (LLM‰ºòÂåñ)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="search-box">
                                <input type="text" x-model="searchQuery" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..."
                                    @keyup.enter="search()">
                                <button class="btn-primary" @click="search()" :disabled="searchLoading">
                                    <span x-show="!searchLoading">ÊêúÁ¥¢</span>
                                    <span x-show="searchLoading" class="loader"></span>
                                </button>
                            </div>

                            <!-- Query Rewrite Visualization -->
                            <div class="rewrite-display" x-show="rewrittenQuery">
                                <div class="rewrite-label">‚ú® Query Â∑≤ÈáçÂÜô:</div>
                                <div class="rewrite-content">
                                    <span class="rewrite-original" x-text="searchQuery"></span>
                                    <span class="rewrite-arrow">‚Üí</span>
                                    <span class="rewrite-result" x-text="rewrittenQuery"></span>
                                </div>
                            </div>

                            <!-- Results -->
                            <div class="search-results" x-show="searchResults.length > 0">
                                <template x-for="(item, index) in searchResults" :key="index">
                                    <div class="result-item">
                                        <div class="result-header">
                                            <span class="result-score"
                                                x-text="'Score: ' + item.score.toFixed(3)"></span>
                                            <span class="badge" :class="{
                                                success: item.search_type.includes('vector'),
                                                primary: item.search_type.includes('hybrid')
                                            }" x-text="formatSearchType(item.search_type)"></span>
                                        </div>
                                        <div class="result-content" x-text="item.content"></div>
                                        <div class="result-source">
                                            <span x-text="'Êù•Ê∫ê: ' + (item.source || 'Êú™Áü•')"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- ================================================================== -->
        <!-- Chat Section -->
        <!-- ================================================================== -->
        <div x-show="nav.isActive('chat')" x-data="chatPage()" class="content-section" x-cloak>
            <div class="chat-layout">
                <!-- Left: Settings -->
                <div class="chat-sidebar">
                    <div class="card">
                        <h2>‚öôÔ∏è ÈÖçÁΩÆ</h2>

                        <div class="form-group">
                            <label>LLM Ê®°Âûã</label>
                            <div class="config-display">
                                <template x-if="activeLLM">
                                    <div>
                                        <div x-text="activeLLM.name"></div>
                                        <div class="text-muted" x-text="activeLLM.model"></div>
                                    </div>
                                </template>
                                <template x-if="!activeLLM">
                                    <div class="text-muted">Êú™ÈÖçÁΩÆ LLM</div>
                                </template>
                            </div>
                        </div>

                        <div class="form-group" style="flex:1; display:flex; flex-direction:column;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label>ÈÄâÊã©Áü•ËØÜÂ∫ì</label>
                                <button class="btn-sm" @click="toggleAll()"
                                    x-text="isAllSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'"></button>
                            </div>
                            <div class="kb-selector">
                                <template x-if="isNoneSelected">
                                    <div class="kb-selector-item" style="opacity:0.7; border-style:dashed;">
                                        <div class="kb-selector-check">
                                            <span>ü§ñ</span>
                                        </div>
                                        <div>
                                            <div>Êô∫ËÉΩË∑ØÁî±Ê®°Âºè</div>
                                            <div class="text-muted text-sm">LLM Â∞ÜËá™Âä®ÈÄâÊã©ÂêàÈÄÇÁöÑÁü•ËØÜÂ∫ì</div>
                                        </div>
                                    </div>
                                </template>
                                <template x-for="kb in kbs" :key="kb.id">
                                    <div class="kb-selector-item" @click="toggleKB(kb.id)"
                                        :class="{ selected: isSelected(kb.id) }">
                                        <div class="kb-selector-check">
                                            <span x-show="isSelected(kb.id)">‚úì</span>
                                        </div>
                                        <div>
                                            <div x-text="kb.name"></div>
                                            <div class="text-muted text-sm" x-text="kb.vdb_type"></div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="kbs.length === 0" class="text-muted">ÊöÇÊó†ÂèØÁî®Áü•ËØÜÂ∫ì</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Chat Area -->
                <div class="card chat-main">
                    <div class="chat-header">
                        <h2>üí¨ Â§öÁü•ËØÜÂ∫ìÈóÆÁ≠î</h2>
                    </div>

                    <div id="chat-messages" class="chat-messages">
                        <template x-for="(msg, index) in messages" :key="index">
                            <div class="message" :class="msg.role">
                                <div class="avatar" x-text="msg.role === 'user' ? 'U' : 'AI'"></div>
                                <div class="message-content">
                                    <div x-html="msg.content.replace(/\n/g, '<br>')"></div>

                                    <!-- Sources -->
                                    <template x-if="msg.sources && msg.sources.length > 0">
                                        <div class="message-sources">
                                            <strong>ÂèÇËÄÉÊù•Ê∫ê:</strong>
                                            <template x-for="(s, si) in msg.sources" :key="si">
                                                <div class="source-item">
                                                    <span class="source-icon"
                                                        x-text="s.type === 'web_search' ? 'üåê' : 'üìÑ'"></span>
                                                    <div>
                                                        <div x-text="s.source || s.title || 'Êù•Ê∫ê ' + (si + 1)"></div>
                                                        <div class="text-muted text-sm"
                                                            x-text="'Score: ' + s.score.toFixed(2)"></div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Evaluation -->
                                    <template x-if="msg.role === 'assistant' && msg.sources?.length > 0">
                                        <div class="eval-section">
                                            <button class="btn-sm" @click="evaluate(index)" x-show="!msg.evaluation"
                                                :disabled="msg.evaluating">
                                                <span x-show="!msg.evaluating">üìä ËØÑ‰º∞ÂõûÁ≠îË¥®Èáè</span>
                                                <span x-show="msg.evaluating">‚è≥ Ê≠£Âú®ËØÑ‰º∞...</span>
                                            </button>
                                            <template x-if="msg.evaluation">
                                                <div class="eval-results">
                                                    <template x-for="(metric, key) in msg.evaluation" :key="key">
                                                        <div class="eval-metric">
                                                            <div class="eval-metric-header">
                                                                <span
                                                                    x-text="key === 'faithfulness' ? 'Âø†ÂÆûÂ∫¶' : (key === 'answer_relevancy' ? 'ÂõûÁ≠îÁõ∏ÂÖ≥ÊÄß' : '‰∏ä‰∏ãÊñáÁõ∏ÂÖ≥ÊÄß')"></span>
                                                                <span x-text="metric.score.toFixed(2)"></span>
                                                            </div>
                                                            <div class="eval-bar">
                                                                <div class="eval-bar-fill"
                                                                    :style="'width:' + (metric.score * 100) + '%'">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Loading indicator -->
                        <div class="message assistant" x-show="loading">
                            <div class="avatar">AI</div>
                            <div class="message-content">
                                <div class="typing-indicator">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <input type="text" x-model="input" placeholder="ËæìÂÖ•ÈóÆÈ¢ò..." @keyup.enter="send()">
                        <button class="btn-primary" @click="send()" :disabled="loading">
                            <span x-show="!loading">ÂèëÈÄÅ</span>
                            <span x-show="loading" class="loader"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================== -->
        <!-- Playground Section -->
        <!-- ================================================================== -->
        <div x-show="nav.isActive('playground')" x-data="playgroundPage()" class="content-section" x-cloak>
            <div class="section-header">
                <div>
                    <h1>üß™ Playground</h1>
                    <p class="subtitle">Êé¢Á¥¢ LangRAG ÁöÑÂêÑÈ°πÂäüËÉΩ</p>
                </div>
            </div>

            <div class="container">
                <!-- Global KB Selector & Query -->
                <div class="card">
                    <h2>üéØ ÊµãËØïÈÖçÁΩÆ</h2>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>ÈÄâÊã©Áü•ËØÜÂ∫ì</label>
                            <select x-model="selectedKB">
                                <option value="">ËØ∑ÈÄâÊã©Áü•ËØÜÂ∫ì...</option>
                                <template x-for="kb in kbs" :key="kb.id">
                                    <option :value="kb.id" x-text="kb.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group" style="flex:2;">
                            <label>ÊµãËØïÊü•ËØ¢</label>
                            <input type="text" x-model="query" placeholder="ËæìÂÖ•ÊµãËØïÊü•ËØ¢...">
                        </div>
                    </div>
                </div>

                <!-- Search Mode Comparison -->
                <div class="card">
                    <div class="card-header-row">
                        <h2>üîç Ê£ÄÁ¥¢Ê®°ÂºèÂØπÊØî</h2>
                        <button class="btn-primary" @click="compareSearchModes()" :disabled="searchCompareLoading">
                            <span x-show="!searchCompareLoading">ÂºÄÂßãÂØπÊØî</span>
                            <span x-show="searchCompareLoading" class="loader"></span>
                        </button>
                    </div>
                    <p class="text-muted">ÂØπÊØî ÂêëÈáèÊ£ÄÁ¥¢„ÄÅÂÖ≥ÈîÆËØçÊ£ÄÁ¥¢„ÄÅÊ∑∑ÂêàÊ£ÄÁ¥¢ ‰∏âÁßçÊ®°ÂºèÁöÑÊïàÊûú</p>

                    <template x-if="searchCompareResults">
                        <div class="compare-grid">
                            <template x-for="mode in searchCompareResults.modes" :key="mode.mode">
                                <div class="compare-column">
                                    <div class="compare-header">
                                        <span x-text="getModeIcon(mode.mode)"></span>
                                        <span x-text="getModeLabel(mode.mode)"></span>
                                        <span class="badge" x-text="mode.time_ms + 'ms'"></span>
                                    </div>
                                    <div class="compare-results">
                                        <template x-for="(r, i) in mode.results" :key="i">
                                            <div class="compare-item">
                                                <div class="compare-item-header">
                                                    <span class="rank-badge" x-text="'#' + (i+1)"></span>
                                                    <span class="score-badge" x-text="r.score.toFixed(3)"></span>
                                                </div>
                                                <div class="compare-item-content" x-text="r.content"></div>
                                            </div>
                                        </template>
                                        <div x-show="mode.results.length === 0" class="text-muted">Êó†ÁªìÊûú</div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Query Rewrite -->
                <div class="card">
                    <h2>‚ú® Query ÈáçÂÜôÂèØËßÜÂåñ</h2>
                    <p class="text-muted">‰ΩøÁî® LLM ‰ºòÂåñÊü•ËØ¢‰ª•ÊèêÈ´òÊ£ÄÁ¥¢ÊïàÊûú</p>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <input type="text" x-model="rewriteQuery" placeholder="ËæìÂÖ•ÂéüÂßãÊü•ËØ¢...">
                        </div>
                        <button class="btn-primary" @click="testRewrite()" :disabled="rewriteLoading">
                            <span x-show="!rewriteLoading">ÊµãËØïÈáçÂÜô</span>
                            <span x-show="rewriteLoading" class="loader"></span>
                        </button>
                    </div>

                    <template x-if="rewriteResult">
                        <div class="rewrite-result">
                            <div class="rewrite-box original">
                                <label>ÂéüÂßãÊü•ËØ¢</label>
                                <div x-text="rewriteResult.original"></div>
                            </div>
                            <div class="rewrite-arrow">‚Üí</div>
                            <div class="rewrite-box rewritten" :class="{ error: rewriteResult.error }">
                                <label x-text="rewriteResult.error ? 'ÈîôËØØ' : 'ÈáçÂÜôÂêé'"></label>
                                <div x-text="rewriteResult.rewritten || rewriteResult.error"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Reranking Comparison -->
                <div class="card">
                    <div class="card-header-row">
                        <h2>üìä Reranking ÊïàÊûúÂØπÊØî</h2>
                        <button class="btn-primary" @click="compareReranking()" :disabled="rerankLoading">
                            <span x-show="!rerankLoading">ÂØπÊØîÈáçÊéíÂ∫è</span>
                            <span x-show="rerankLoading" class="loader"></span>
                        </button>
                    </div>
                    <p class="text-muted">ÂØπÊØîÈáçÊéíÂ∫èÂâçÂêéÁöÑÁªìÊûúÊéíÂêçÂèòÂåñ</p>

                    <template x-if="rerankResults">
                        <div>
                            <div class="rerank-status">
                                <span class="badge" :class="{ success: rerankResults.reranker_active }">
                                    <span x-text="rerankResults.reranker_active ? '‚úì Reranker: ' + rerankResults.reranker_name : '‚ö† Êú™ÈÖçÁΩÆ Reranker'"></span>
                                </span>
                            </div>
                            <div class="rerank-table">
                                <div class="rerank-header">
                                    <span>ÂÜÖÂÆπ</span>
                                    <span>ÂéüÂßãÂàÜÊï∞</span>
                                    <span>ÂéüÂßãÊéíÂêç</span>
                                    <span>ÈáçÊéíÂàÜÊï∞</span>
                                    <span>Êñ∞ÊéíÂêç</span>
                                    <span>ÂèòÂåñ</span>
                                </div>
                                <template x-for="(r, i) in rerankResults.results" :key="i">
                                    <div class="rerank-row">
                                        <span class="rerank-content" x-text="r.content"></span>
                                        <span x-text="r.original_score.toFixed(3)"></span>
                                        <span class="rank-badge" x-text="'#' + r.rank_before"></span>
                                        <span x-text="r.reranked_score !== null ? r.reranked_score.toFixed(3) : '-'"></span>
                                        <span class="rank-badge" x-text="r.rank_after !== null ? '#' + r.rank_after : '-'"></span>
                                        <span :class="getRankChangeClass(r.rank_change)">
                                            <span x-show="r.rank_change !== null" x-text="getRankChangeIcon(r.rank_change) + Math.abs(r.rank_change || 0)"></span>
                                            <span x-show="r.rank_change === null">-</span>
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Semantic Cache Analysis -->
                <div class="card">
                    <div class="card-header-row">
                        <h2>üíæ ËØ≠‰πâÁºìÂ≠òÂàÜÊûê</h2>
                        <button class="btn-secondary" @click="clearCache()">Ê∏ÖÁ©∫ÁºìÂ≠ò</button>
                    </div>
                    <p class="text-muted">ÂàÜÊûêËØ≠‰πâÁºìÂ≠òÂëΩ‰∏≠ÊÉÖÂÜµ</p>

                    <template x-if="cacheStats">
                        <div class="cache-stats-grid">
                            <div class="cache-stat">
                                <div class="cache-stat-value" :class="{ success: cacheStats.enabled }">
                                    <span x-text="cacheStats.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'"></span>
                                </div>
                                <div class="cache-stat-label">ÁºìÂ≠òÁä∂ÊÄÅ</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value" x-text="cacheStats.hits"></div>
                                <div class="cache-stat-label">ÂëΩ‰∏≠Ê¨°Êï∞</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value" x-text="cacheStats.misses"></div>
                                <div class="cache-stat-label">Êú™ÂëΩ‰∏≠</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value" x-text="formatHitRate(cacheStats.hit_rate)"></div>
                                <div class="cache-stat-label">ÂëΩ‰∏≠Áéá</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value" x-text="cacheStats.size + '/' + cacheStats.max_size"></div>
                                <div class="cache-stat-label">ÁºìÂ≠òÂ§ßÂ∞è</div>
                            </div>
                            <div class="cache-stat">
                                <div class="cache-stat-value" x-text="cacheStats.similarity_threshold"></div>
                                <div class="cache-stat-label">Áõ∏‰ººÂ∫¶ÈòàÂÄº</div>
                            </div>
                        </div>
                    </template>

                    <div class="cache-test-section">
                        <h3>ÁºìÂ≠òÂëΩ‰∏≠ÊµãËØï</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex:1;">
                                <input type="text" x-model="cacheTestQuery" placeholder="ËæìÂÖ•Êü•ËØ¢ÊµãËØïÁºìÂ≠òÂëΩ‰∏≠...">
                            </div>
                            <button class="btn-primary" @click="testCacheHit()" :disabled="cacheLoading">
                                <span x-show="!cacheLoading">ÊµãËØï</span>
                                <span x-show="cacheLoading" class="loader"></span>
                            </button>
                        </div>

                        <template x-if="cacheTestResult">
                            <div class="cache-test-result" :class="{ hit: cacheTestResult.is_cache_hit }">
                                <div class="cache-result-icon">
                                    <span x-text="cacheTestResult.is_cache_hit ? '‚úì' : '‚úó'"></span>
                                </div>
                                <div class="cache-result-info">
                                    <div class="cache-result-status" x-text="cacheTestResult.is_cache_hit ? 'ÁºìÂ≠òÂëΩ‰∏≠!' : 'ÁºìÂ≠òÊú™ÂëΩ‰∏≠'"></div>
                                    <div class="text-muted" x-text="'ÊêúÁ¥¢Á±ªÂûã: ' + cacheTestResult.search_type"></div>
                                    <div x-show="cacheTestResult.matched_query" class="text-muted" x-text="'ÂåπÈÖçÊü•ËØ¢: ' + cacheTestResult.matched_query"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

            </div>
        </div>

        <!-- ================================================================== -->
        <!-- Models Config Section -->
        <!-- ================================================================== -->
        <div x-show="nav.isActive('models')" x-data="modelsPage()" class="content-section" x-cloak>
            <div class="section-header">
                <div>
                    <h1>‚öôÔ∏è Ê®°ÂûãÈÖçÁΩÆ</h1>
                    <p class="subtitle">ÈÖçÁΩÆ Embedding Âíå LLM Ê®°Âûã</p>
                </div>
            </div>

            <div class="container">
                <!-- Embedder Section -->
                <div class="config-section">
                    <h2 class="config-section-title">
                        <span class="dot primary"></span>
                        Embedding Ê®°Âûã
                    </h2>

                    <div class="config-grid">
                        <!-- Embedder List -->
                        <div class="card">
                            <h3>Â∑≤ÈÖçÁΩÆÂàóË°®</h3>
                            <div class="config-list" x-show="embedders.length === 0">
                                <p class="text-muted">ÊöÇÊó†ÈÖçÁΩÆ</p>
                            </div>
                            <div class="config-list" x-show="embedders.length > 0">
                                <template x-for="emb in embedders" :key="emb.name">
                                    <div class="config-item" @click="activateEmbedder(emb.name)">
                                        <div>
                                            <div class="config-item-name" x-text="emb.name"></div>
                                            <div class="text-muted text-sm" x-text="emb.model"></div>
                                        </div>
                                        <span class="badge" :class="{ success: emb.is_active }"
                                            x-text="emb.is_active ? 'Active' : emb.embedder_type"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Embedder Form -->
                        <div class="card">
                            <h3>Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ</h3>
                            <div class="form-group">
                                <label>ÈÖçÁΩÆÂêçÁß∞ *</label>
                                <input type="text" x-model="embForm.name" placeholder="‰æãÂ¶ÇÔºöopenai-default">
                            </div>
                            <div class="form-group">
                                <label>Á±ªÂûã *</label>
                                <select x-model="embForm.embedder_type" @change="onEmbTypeChange()">
                                    <option value="openai">OpenAI ÂÖºÂÆπ API</option>
                                    <option value="seekdb">SeekDB ÂÜÖÁΩÆÊ®°Âûã</option>
                                </select>
                            </div>

                            <!-- SeekDB Info -->
                            <div class="info-box" x-show="isSeekDB">
                                <strong>SeekDB ÂÜÖÁΩÆÊ®°Âûã</strong><br>
                                <span class="text-muted">
                                    Ê®°ÂûãÔºöall-MiniLM-L6-v2 (384Áª¥)<br>
                                    ÂÆåÂÖ®Á¶ªÁ∫øÔºåÊó†ÈúÄ API Key
                                </span>
                            </div>

                            <!-- OpenAI Fields -->
                            <template x-if="!isSeekDB">
                                <div>
                                    <div class="form-group">
                                        <label>Base URL *</label>
                                        <input type="text" x-model="embForm.base_url"
                                            placeholder="https://api.openai.com/v1">
                                    </div>
                                    <div class="form-group">
                                        <label>API Key *</label>
                                        <input type="password" x-model="embForm.api_key" placeholder="sk-...">
                                    </div>
                                    <div class="form-group">
                                        <label>Model Name *</label>
                                        <input type="text" x-model="embForm.model" placeholder="text-embedding-3-small">
                                    </div>
                                </div>
                            </template>

                            <button class="btn-primary" @click="saveEmbedder()" :disabled="embSaving">
                                <span x-show="!embSaving">‰øùÂ≠ò Embedder</span>
                                <span x-show="embSaving" class="loader"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- LLM Section -->
                <div class="config-section">
                    <h2 class="config-section-title">
                        <span class="dot success"></span>
                        LLM (ÂØπËØùÊ®°Âûã)
                    </h2>

                    <div class="config-grid">
                        <!-- LLM List -->
                        <div class="card">
                            <h3>Â∑≤ÈÖçÁΩÆÂàóË°®</h3>
                            <div class="config-list" x-show="llms.length === 0">
                                <p class="text-muted">ÊöÇÊó†ÈÖçÁΩÆ</p>
                            </div>
                            <div class="config-list" x-show="llms.length > 0">
                                <template x-for="llm in llms" :key="llm.name">
                                    <div class="config-item" @click="activateLLM(llm.name)">
                                        <div>
                                            <div class="config-item-name" x-text="llm.name"></div>
                                            <div class="text-muted text-sm" x-text="llm.model"></div>
                                        </div>
                                        <span class="badge" :class="{ success: llm.is_active }"
                                            x-text="llm.is_active ? 'Active' : 'Inactive'"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- LLM Form -->
                        <div class="card">
                            <h3>Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ</h3>
                            <div class="form-group">
                                <label>‰æõÂ∫îÂïÜ</label>
                                <select x-model="llmForm.provider" @change="onLLMProviderChange()">
                                    <option value="kimi">Moonshot AI (Kimi)</option>
                                    <option value="custom">Custom (OpenAI ÂÖºÂÆπ)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÈÖçÁΩÆÂêçÁß∞ *</label>
                                <input type="text" x-model="llmForm.name" placeholder="‰æãÂ¶ÇÔºökimi-default">
                            </div>
                            <div class="form-group">
                                <label>Base URL *</label>
                                <input type="text" x-model="llmForm.base_url" placeholder="https://api.moonshot.cn/v1">
                            </div>
                            <div class="form-group">
                                <label>API Key *</label>
                                <input type="password" x-model="llmForm.api_key" placeholder="sk-...">
                            </div>
                            <div class="form-group">
                                <label>Model Name *</label>
                                <input type="text" x-model="llmForm.model" placeholder="moonshot-v1-8k">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Temperature</label>
                                    <input type="number" x-model.number="llmForm.temperature" step="0.1" min="0"
                                        max="2">
                                </div>
                                <div class="form-group">
                                    <label>Max Tokens</label>
                                    <input type="number" x-model.number="llmForm.max_tokens" step="128">
                                </div>
                            </div>

                            <button class="btn-primary" @click="saveLLM()" :disabled="llmSaving">
                                <span x-show="!llmSaving">‰øùÂ≠ò LLM</span>
                                <span x-show="llmSaving" class="loader"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

</body>

</html>